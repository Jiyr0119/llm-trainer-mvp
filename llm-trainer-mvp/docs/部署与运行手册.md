# LLM Trainer 部署与运行手册

## 目录

1. [项目概述](#项目概述)
2. [系统要求](#系统要求)
3. [前端部署](#前端部署)

## 前端部署

### 前端环境准备

1. **安装 Node.js**
   - 下载并安装 Node.js v16.0.0 或更高版本: [https://nodejs.org/](https://nodejs.org/)
   - 验证安装:
     ```bash
     node -v
     npm -v
     ```

2. **安装构建工具**
   - 确保全局安装了最新版本的 npm:
     ```bash
     npm install -g npm@latest
     ```

### 前端安装步骤

1. **获取源代码**
   ```bash
   git clone https://github.com/your-username/llm-trainer.git
   cd llm-trainer/llm-trainer-mvp/frontend
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

### 前端配置说明

前端配置主要通过环境文件进行管理，项目包含三个环境配置文件：

- `.env.development`: 开发环境配置
- `.env.test`: 测试环境配置
- `.env.production`: 生产环境配置

**主要配置参数**:

| 参数 | 说明 | 示例值 |
|------|------|--------|
| VITE_APP_ENV | 环境标识 | dev, test, prod |
| VITE_APP_API_URL | 后端API地址 | http://localhost:8001 |
| VITE_APP_TITLE | 应用标题 | LLM Trainer |
| VITE_APP_DEBUG | 调试模式 | true, false |

**修改配置**:

根据部署环境，您可能需要修改 `.env.production` 文件中的 `VITE_APP_API_URL` 参数，确保其指向正确的后端API地址。

### 前端启动服务

**开发环境**:

```bash
# 切换到开发环境配置
npm run env:dev

# 启动开发服务器
npm run dev
```

**生产环境部署**:

1. **构建生产版本**
   ```bash
   # 切换到生产环境配置
   npm run env:prod
   
   # 构建项目
   npm run build
   ```

2. **部署到Web服务器**

   构建完成后，`dist` 目录包含所有静态文件，可以部署到任何Web服务器：

   - **Nginx配置示例**:
     ```nginx
     server {
         listen 80;
         server_name your-domain.com;
         root /path/to/llm-trainer/frontend/dist;
         index index.html;
         
         location / {
             try_files $uri $uri/ /index.html;
         }
         
         # 代理API请求到后端服务
         location /api/ {
             proxy_pass http://localhost:8001/;
             proxy_set_header Host $host;
             proxy_set_header X-Real-IP $remote_addr;
         }
     }
     ```

   - **Apache配置示例**:
     创建 `.htaccess` 文件在 `dist` 目录中：
     ```apache
     <IfModule mod_rewrite.c>
       RewriteEngine On
       RewriteBase /
       RewriteRule ^index\.html$ - [L]
       RewriteCond %{REQUEST_FILENAME} !-f
       RewriteCond %{REQUEST_FILENAME} !-d
       RewriteRule . /index.html [L]
     </IfModule>
     ```

3. **使用静态文件服务器**

   也可以使用简单的静态文件服务器：
   ```bash
   # 使用serve工具（需要先安装）
   npm install -g serve
   serve -s dist
   ```
4. [后端部署](#后端部署)

## 后端部署

### 后端环境准备

1. **安装 Python**
   - 下载并安装 Python 3.8 或更高版本: [https://www.python.org/downloads/](https://www.python.org/downloads/)
   - 验证安装:
     ```bash
     python --version
     pip --version
     ```

2. **安装虚拟环境工具**
   ```bash
   pip install virtualenv
   ```

3. **GPU支持** (可选，但推荐用于训练)
   - 如果您有NVIDIA GPU，请安装CUDA和cuDNN
   - 参考 [PyTorch官方安装指南](https://pytorch.org/get-started/locally/) 获取适合您系统的安装命令

### 后端安装步骤

1. **获取源代码**
   ```bash
   git clone https://github.com/your-username/llm-trainer.git
   cd llm-trainer/llm-trainer-mvp/backend
   ```

2. **创建并激活虚拟环境**
   ```bash
   # 创建虚拟环境
   python -m virtualenv venv
   
   # 在Linux/macOS上激活
   source venv/bin/activate
   
   # 在Windows上激活
   venv\Scripts\activate
   ```

3. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **下载预训练模型** (可选)
   ```bash
   python download_model.py
   ```

### 后端配置说明

后端配置主要通过环境文件进行管理，项目包含三个环境配置文件：

- `.env.dev`: 开发环境配置
- `.env.test`: 测试环境配置
- `.env.prod`: 生产环境配置

**主要配置参数**:

| 参数 | 说明 | 示例值 |
|------|------|--------|
| APP_ENV | 环境标识 | dev, test, prod |
| DEBUG | 调试模式 | true, false |
| HOST | 服务器主机 | 0.0.0.0 |
| PORT | 服务器端口 | 8001 |
| DATABASE_URL | 数据库连接URL | sqlite:///../data/database.db |
| UPLOAD_PATH | 上传文件存储路径 | ../data/uploads |
| MODEL_PATH | 模型存储路径 | ../data/models |
| LOG_PATH | 日志存储路径 | ../data/logs |
| LOG_LEVEL | 日志级别 | DEBUG, INFO, WARNING, ERROR |
| CORS_ORIGINS | 允许的跨域来源 | * |

**修改配置**:

根据部署环境，您可能需要修改以下配置：

1. 在生产环境中，将 `DEBUG` 设置为 `false`
2. 调整 `DATABASE_URL` 以使用生产数据库
3. 设置适当的 `CORS_ORIGINS` 值，限制允许的来源

### 后端启动服务

**开发环境**:

```bash
# 设置环境变量
export APP_ENV=dev  # Linux/macOS
# 或
set APP_ENV=dev  # Windows

# 启动开发服务器
uvicorn main:app --reload --host 0.0.0.0 --port 8001
```

**生产环境部署**:

1. **使用Uvicorn**
   ```bash
   # 设置环境变量
   export APP_ENV=prod  # Linux/macOS
   # 或
   set APP_ENV=prod  # Windows
   
   # 启动生产服务器
   uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
   ```

2. **使用Gunicorn** (仅Linux/macOS)
   ```bash
   # 安装gunicorn
   pip install gunicorn
   
   # 启动服务
   APP_ENV=prod gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8001
   ```

3. **使用Systemd服务** (Linux)

   创建服务文件 `/etc/systemd/system/llm-trainer.service`:
   ```ini
   [Unit]
   Description=LLM Trainer Backend
   After=network.target
   
   [Service]
   User=your_user
   Group=your_group
   WorkingDirectory=/path/to/llm-trainer/backend
   Environment="APP_ENV=prod"
   ExecStart=/path/to/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   ```

   启动服务:
   ```bash
   sudo systemctl enable llm-trainer
   sudo systemctl start llm-trainer
   sudo systemctl status llm-trainer
   ```

4. **使用Docker** (需要Dockerfile)

   创建 `Dockerfile`:
   ```dockerfile
   FROM python:3.10-slim
   
   WORKDIR /app
   
   COPY requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   
   COPY . .
   
   ENV APP_ENV=prod
   
   EXPOSE 8001
   
   CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
   ```

   构建和运行:
   ```bash
   docker build -t llm-trainer-backend .
   docker run -d -p 8001:8001 --name llm-trainer-backend llm-trainer-backend
   ```
5. [环境配置](#环境配置)
6. [常见问题与故障排除](#常见问题与故障排除)

## 环境配置

### 开发环境

开发环境主要用于本地开发和调试，配置相对宽松。

**前端开发环境配置**:

1. 在 `.env.development` 文件中设置：
   ```
   VITE_APP_ENV=development
   VITE_APP_TITLE=LLM Trainer (开发环境)
   VITE_APP_DEBUG=true
   VITE_APP_API_URL=http://localhost:8001
   ```

2. 启动前端开发服务器：
   ```bash
   npm run dev
   ```

**后端开发环境配置**:

1. 在 `.env.dev` 文件中设置：
   ```
   APP_ENV=dev
   DEBUG=true
   HOST=0.0.0.0
   PORT=8001
   DATABASE_URL=sqlite:///../data/database.db
   UPLOAD_PATH=../data/uploads
   MODEL_PATH=../data/models
   LOG_PATH=../data/logs
   LOG_LEVEL=DEBUG
   LOG_FILE=app.log
   CORS_ORIGINS=*
   ```

2. 启动后端开发服务器：
   ```bash
   export APP_ENV=dev  # Linux/macOS
   # 或
   set APP_ENV=dev  # Windows
   
   uvicorn main:app --reload --host 0.0.0.0 --port 8001
   ```

### 测试环境

测试环境用于功能测试和集成测试，配置应接近生产环境。

**前端测试环境配置**:

1. 在 `.env.test` 文件中设置：
   ```
   VITE_APP_ENV=test
   VITE_APP_TITLE=LLM Trainer (测试环境)
   VITE_APP_DEBUG=false
   VITE_APP_API_URL=https://api-test.llm-trainer.example.com
   ```

2. 构建测试环境前端：
   ```bash
   npm run build:test
   ```

**后端测试环境配置**:

1. 在 `.env.test` 文件中设置：
   ```
   APP_ENV=test
   DEBUG=false
   HOST=0.0.0.0
   PORT=8001
   DATABASE_URL=sqlite:///../data/test_database.db
   UPLOAD_PATH=../data/test_uploads
   MODEL_PATH=../data/test_models
   LOG_PATH=../data/test_logs
   LOG_LEVEL=INFO
   LOG_FILE=app_test.log
   CORS_ORIGINS=https://test.llm-trainer.example.com
   ```

2. 启动后端测试服务器：
   ```bash
   export APP_ENV=test  # Linux/macOS
   # 或
   set APP_ENV=test  # Windows
   
   uvicorn main:app --host 0.0.0.0 --port 8001
   ```

### 生产环境

生产环境用于实际部署，需要更严格的安全配置和性能优化。

**前端生产环境配置**:

1. 在 `.env.production` 文件中设置：
   ```
   VITE_APP_ENV=production
   VITE_APP_TITLE=LLM Trainer
   VITE_APP_DEBUG=false
   VITE_APP_API_URL=https://api.llm-trainer.example.com
   ```

2. 构建生产环境前端：
   ```bash
   npm run build
   ```

**后端生产环境配置**:

1. 在 `.env.prod` 文件中设置：
   ```
   APP_ENV=prod
   DEBUG=false
   HOST=0.0.0.0
   PORT=8001
   DATABASE_URL=postgresql://user:password@localhost:5432/llm_trainer
   UPLOAD_PATH=/var/data/llm-trainer/uploads
   MODEL_PATH=/var/data/llm-trainer/models
   LOG_PATH=/var/log/llm-trainer
   LOG_LEVEL=WARNING
   LOG_FILE=app_prod.log
   CORS_ORIGINS=https://llm-trainer.example.com
   ```

2. 启动后端生产服务器：
   ```bash
   export APP_ENV=prod  # Linux/macOS
   # 或
   set APP_ENV=prod  # Windows
   
   # 使用多工作进程
   uvicorn main:app --host 0.0.0.0 --port 8001 --workers 4
   # 或使用 Gunicorn
   gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8001
   ```

### 环境变量优先级

系统配置加载优先级如下：

1. 命令行设置的环境变量（最高优先级）
2. 操作系统环境变量
3. 环境配置文件（.env.dev, .env.test, .env.prod）
4. 默认配置（最低优先级）

这意味着您可以通过设置环境变量来覆盖配置文件中的设置，例如：

```bash
# 覆盖端口配置
PORT=9000 uvicorn main:app

# 覆盖数据库配置
DATABASE_URL=postgresql://user:password@db:5432/prod_db uvicorn main:app
```

## 常见问题与故障排除

### 前端问题

1. **前端构建失败**
   - **问题**: npm run build 命令失败
   - **解决方案**: 
     - 确保 Node.js 版本兼容（v16+）
     - 删除 node_modules 目录并重新安装依赖
     - 检查 package.json 中的依赖版本是否有冲突

2. **API 连接失败**
   - **问题**: 前端无法连接到后端 API
   - **解决方案**:
     - 检查 .env 文件中的 VITE_APP_API_URL 配置
     - 确认后端服务正在运行
     - 检查网络连接和防火墙设置
     - 检查浏览器控制台是否有 CORS 错误

3. **页面样式异常**
   - **问题**: 页面显示不正常或样式丢失
   - **解决方案**:
     - 清除浏览器缓存
     - 检查是否有 CSS 文件加载失败
     - 尝试使用不同的浏览器

### 后端问题

1. **依赖安装失败**
   - **问题**: pip install -r requirements.txt 命令失败
   - **解决方案**:
     - 更新 pip: `pip install --upgrade pip`
     - 检查 Python 版本兼容性（3.8+）
     - 对于 PyTorch 相关错误，参考 PyTorch 官方安装指南

2. **服务启动失败**
   - **问题**: uvicorn 无法启动服务
   - **解决方案**:
     - 检查端口是否被占用: `lsof -i :8001` (Linux/macOS) 或 `netstat -ano | findstr 8001` (Windows)
     - 确认环境变量设置正确
     - 检查日志文件中的详细错误信息

3. **数据库连接错误**
   - **问题**: 无法连接到数据库
   - **解决方案**:
     - 检查 DATABASE_URL 配置
     - 确认数据库服务正在运行
     - 验证数据库用户权限
     - 对于 SQLite，确保目录可写

4. **模型加载失败**
   - **问题**: 无法加载预训练模型
   - **解决方案**:
     - 确认 MODEL_PATH 目录存在且有正确的权限
     - 检查磁盘空间是否充足
     - 对于 GPU 相关错误，确认 CUDA 安装正确

### 部署问题

1. **Nginx 配置问题**
   - **问题**: Nginx 无法正确代理请求
   - **解决方案**:
     - 检查 Nginx 配置文件语法: `nginx -t`
     - 确认代理路径和目标地址正确
     - 检查 Nginx 错误日志

2. **Docker 容器问题**
   - **问题**: Docker 容器无法启动或运行异常
   - **解决方案**:
     - 检查 Docker 日志: `docker logs llm-trainer-backend`
     - 确认 Dockerfile 中的基础镜像兼容性
     - 验证容器网络配置

3. **系统服务问题**
   - **问题**: systemd 服务无法启动
   - **解决方案**:
     - 检查服务状态: `systemctl status llm-trainer`
     - 查看日志: `journalctl -u llm-trainer`
     - 确认服务文件中的路径和权限设置正确

### 日志查看

排查问题时，查看日志是非常重要的步骤：

- **前端日志**: 浏览器开发者工具 -> 控制台
- **后端日志**: 
  - 开发环境: 控制台输出
  - 生产环境: 查看配置的日志文件，默认位于 LOG_PATH 目录

### 获取支持

如果您遇到无法解决的问题，可以通过以下方式获取支持：

1. 提交 GitHub Issue: [https://github.com/your-username/llm-trainer/issues](https://github.com/your-username/llm-trainer/issues)
2. 查阅项目 Wiki 文档
3. 联系技术支持团队

## 项目概述

LLM Trainer 是一个用于训练和微调大型语言模型的应用程序，包含前端界面和后端API服务。本手册提供了详细的部署和运行指南，帮助您快速搭建和使用系统。

## 系统要求

### 硬件要求

- **CPU**: 4核或更高
- **内存**: 最小8GB，推荐16GB或更高
- **存储**: 最小20GB可用空间，用于应用程序和模型存储
- **GPU**: 训练模型时推荐使用NVIDIA GPU (至少8GB显存)

### 软件要求

- **操作系统**: Linux (推荐Ubuntu 20.04+), macOS, Windows 10+
- **Node.js**: v16.0.0 或更高版本
- **Python**: 3.8 或更高版本
- **数据库**: SQLite (默认，内置)

以下各章节将详细介绍前端和后端的部署步骤、环境配置以及常见问题的解决方案。