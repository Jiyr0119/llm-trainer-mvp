# 数据库学习与连接指南

## PostgreSQL 数据库连接信息

### 连接参数

以下是连接到 LLM Trainer 项目 PostgreSQL 数据库的参数，可用于 DBeaver 或其他数据库管理工具：

- **主机(Host)**: localhost
- **端口(Port)**: 5432
- **数据库名(Database)**: llm_trainer
- **用户名(Username)**: postgres
- **密码(Password)**: postgres
- **URL**: `postgresql://postgres:postgres@localhost:5432/llm_trainer`

### 使用 DBeaver 连接数据库

1. 下载并安装 [DBeaver](https://dbeaver.io/download/)
2. 打开 DBeaver，点击「新建连接」按钮
3. 选择 PostgreSQL 数据库类型
4. 填入上述连接参数
5. 点击「测试连接」确保连接成功
6. 点击「完成」保存连接

## 数据库学习知识

### 关系型数据库基础

#### 什么是关系型数据库

关系型数据库是基于关系模型的数据库，使用表格存储数据，表之间通过关系连接。主要特点：

- 使用表格结构存储数据
- 支持SQL查询语言
- 强调数据一致性和ACID特性
- 支持复杂查询和事务处理

#### 常见关系型数据库

- **SQLite**: 轻量级、嵌入式数据库，适合小型应用和开发环境
- **PostgreSQL**: 功能强大的开源数据库，支持高级特性和扩展
- **MySQL/MariaDB**: 流行的开源数据库，性能优良
- **Oracle**: 企业级商业数据库，功能全面
- **SQL Server**: 微软的企业级数据库解决方案

### SQLite 与 PostgreSQL 对比

| 特性 | SQLite | PostgreSQL |
|------|--------|------------|
| 类型 | 嵌入式数据库 | 客户端-服务器数据库 |
| 存储 | 单文件 | 多文件系统 |
| 并发 | 有限支持 | 完全支持 |
| 性能 | 小数据量快 | 大数据量优势明显 |
| 扩展性 | 有限 | 高度可扩展 |
| 高级特性 | 基础功能 | 完整SQL支持、JSON、全文搜索等 |
| 适用场景 | 小型应用、开发测试 | 生产环境、大型应用 |

### PostgreSQL 核心概念

#### 数据类型

PostgreSQL 支持丰富的数据类型：

- 基本类型：INTEGER, BIGINT, REAL, DOUBLE PRECISION, CHAR, VARCHAR, TEXT, BOOLEAN
- 日期时间：DATE, TIME, TIMESTAMP, INTERVAL
- 特殊类型：JSON, JSONB, UUID, ARRAY, HSTORE
- 几何类型：POINT, LINE, POLYGON

#### 索引类型

- B-tree：默认索引，适用于大多数场景
- Hash：等值查询优化
- GiST：几何数据和全文搜索
- GIN：反向索引，适用于多值类型
- BRIN：大表范围查询

#### 事务与ACID

PostgreSQL 完全支持 ACID 特性：

- **原子性(Atomicity)**: 事务作为一个整体执行，要么全部成功，要么全部失败
- **一致性(Consistency)**: 事务执行前后数据库保持一致状态
- **隔离性(Isolation)**: 并发事务之间相互隔离
- **持久性(Durability)**: 事务一旦提交，结果永久保存

### Python 中使用 PostgreSQL

#### SQLAlchemy ORM

SQLAlchemy 是 Python 中流行的 ORM 工具，提供了高级 API 来操作数据库：

```python
# 创建连接
from sqlalchemy import create_engine
engine = create_engine('postgresql://postgres:postgres@localhost:5432/llm_trainer')

# 定义模型
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    posts = relationship("Post", back_populates="author")

class Post(Base):
    __tablename__ = 'posts'
    id = Column(Integer, primary_key=True)
    title = Column(String)
    author_id = Column(Integer, ForeignKey('users.id'))
    author = relationship("User", back_populates="posts")

# 创建表
Base.metadata.create_all(engine)

# 使用会话进行操作
from sqlalchemy.orm import sessionmaker
Session = sessionmaker(bind=engine)
session = Session()

# 增加数据
new_user = User(name="张三")
session.add(new_user)
session.commit()

# 查询数据
users = session.query(User).all()
for user in users:
    print(user.name)
```

#### SQLModel

SQLModel 是基于 SQLAlchemy 和 Pydantic 的现代 ORM 库，在 LLM Trainer 项目中使用：

```python
from sqlmodel import SQLModel, Field, create_engine, Session

class User(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str
    email: str

# 创建引擎
engine = create_engine("postgresql://postgres:postgres@localhost:5432/llm_trainer")

# 创建表
SQLModel.metadata.create_all(engine)

# 使用会话
with Session(engine) as session:
    # 创建用户
    user = User(name="李四", email="lisi@example.com")
    session.add(user)
    session.commit()
    
    # 刷新以获取自动生成的ID
    session.refresh(user)
    print(f"用户ID: {user.id}")
    
    # 查询
    users = session.query(User).all()
    for u in users:
        print(f"{u.id}: {u.name} ({u.email})")
```

### 数据库连接池

在生产环境中，使用连接池可以提高性能和资源利用率：

```python
from sqlalchemy.pool import QueuePool

engine = create_engine(
    "postgresql://postgres:postgres@localhost:5432/llm_trainer",
    poolclass=QueuePool,
    pool_size=5,           # 连接池大小
    max_overflow=10,       # 最大溢出连接数
    pool_timeout=30,       # 获取连接超时时间
    pool_recycle=1800,     # 连接回收时间
)
```

### 数据库迁移

使用 Alembic 进行数据库迁移管理：

```bash
# 安装Alembic
pip install alembic

# 初始化迁移环境
alembic init migrations

# 创建迁移脚本
alembic revision --autogenerate -m "创建用户表"

# 应用迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

## 最佳实践

1. **使用参数化查询**：防止SQL注入攻击
2. **合理使用索引**：提高查询性能
3. **事务管理**：确保数据一致性
4. **连接池**：高效管理数据库连接
5. **定期备份**：防止数据丢失
6. **监控性能**：识别并解决性能瓶颈
7. **使用ORM**：提高代码可维护性
8. **版本控制**：使用迁移工具管理数据库结构变更

## 参考资源

- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [SQLAlchemy 文档](https://docs.sqlalchemy.org/)
- [SQLModel 文档](https://sqlmodel.tiangolo.com/)
- [Alembic 文档](https://alembic.sqlalchemy.org/)
- [DBeaver 官网](https://dbeaver.io/)